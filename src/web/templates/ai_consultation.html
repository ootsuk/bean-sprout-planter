<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>豆苗プランター - AI相談</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            background-color: #f8f9fa;
        }
        .message {
            margin-bottom: 1rem;
        }
        .user-message {
            text-align: right;
        }
        .ai-message {
            text-align: left;
        }
        .message-bubble {
            display: inline-block;
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            word-wrap: break-word;
        }
        .user-bubble {
            background-color: #007bff;
            color: white;
        }
        .ai-bubble {
            background-color: white;
            border: 1px solid #dee2e6;
        }
        .tag-badge {
            cursor: pointer;
            transition: all 0.2s;
        }
        .tag-badge:hover {
            transform: scale(1.05);
        }
        .tag-badge.active {
            background-color: #28a745 !important;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-seedling"></i> 豆苗プランター
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">ダッシュボード</a>
                <a class="nav-link active" href="/ai-consultation">AI相談</a>
                <a class="nav-link" href="/multi-camera">カメラ管理</a>
                <a class="nav-link" href="/water-tank">給水タンク</a>
                <a class="nav-link" href="/settings">設定</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-robot"></i> AI相談
                </h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <!-- チャットエリア -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-comments"></i> 豆苗栽培相談</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="chat-container" id="chat-container">
                            <div class="message ai-message">
                                <div class="message-bubble ai-bubble">
                                    <i class="fas fa-robot"></i> 
                                    こんにちは！豆苗栽培の専門AIです。何でもお聞きください。
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="input-group">
                            <input type="text" class="form-control" id="question-input" placeholder="豆苗栽培について質問してください...">
                            <button class="btn btn-primary" onclick="sendQuestion()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <!-- 相談タグ -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6><i class="fas fa-tags"></i> 相談カテゴリ</h6>
                    </div>
                    <div class="card-body">
                        <div id="tags-container">
                            <span class="badge bg-secondary tag-badge me-1 mb-1" onclick="selectTag('general')">一般相談</span>
                            <span class="badge bg-secondary tag-badge me-1 mb-1" onclick="selectTag('harvest')">収穫判断</span>
                            <span class="badge bg-secondary tag-badge me-1 mb-1" onclick="selectTag('disease')">病気診断</span>
                            <span class="badge bg-secondary tag-badge me-1 mb-1" onclick="selectTag('cooking')">調理例</span>
                            <span class="badge bg-secondary tag-badge me-1 mb-1" onclick="selectTag('watering')">水やり</span>
                            <span class="badge bg-secondary tag-badge me-1 mb-1" onclick="selectTag('lighting')">光量</span>
                            <span class="badge bg-secondary tag-badge me-1 mb-1" onclick="selectTag('temperature')">温度管理</span>
                            <span class="badge bg-secondary tag-badge me-1 mb-1" onclick="selectTag('nutrients')">栄養管理</span>
                        </div>
                    </div>
                </div>

                <!-- クイックアクション -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6><i class="fas fa-bolt"></i> クイックアクション</h6>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success w-100 mb-2" onclick="quickAction('harvest')">
                            <i class="fas fa-cut"></i> 収穫判断
                        </button>
                        <button class="btn btn-warning w-100 mb-2" onclick="quickAction('disease')">
                            <i class="fas fa-stethoscope"></i> 病気診断
                        </button>
                        <button class="btn btn-info w-100 mb-2" onclick="quickAction('cooking')">
                            <i class="fas fa-utensils"></i> 調理例
                        </button>
                    </div>
                </div>

                <!-- 相談履歴 -->
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-history"></i> 相談履歴</h6>
                    </div>
                    <div class="card-body">
                        <div id="history-container">
                            <p class="text-muted small">相談履歴が表示されます</p>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm w-100" onclick="loadHistory()">
                            <i class="fas fa-refresh"></i> 履歴を更新
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedTag = 'general';

        // タグ選択
        function selectTag(tag) {
            selectedTag = tag;
            
            // タグの見た目を更新
            document.querySelectorAll('.tag-badge').forEach(badge => {
                badge.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // 質問送信
        function sendQuestion() {
            const question = document.getElementById('question-input').value.trim();
            if (!question) return;

            const chatContainer = document.getElementById('chat-container');
            
            // ユーザーメッセージを追加
            chatContainer.innerHTML += `
                <div class="message user-message">
                    <div class="message-bubble user-bubble">
                        ${question}
                    </div>
                </div>
            `;

            // AI回答を取得
            fetch('/api/ai/consultation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: question,
                    tag: selectedTag
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    chatContainer.innerHTML += `
                        <div class="message ai-message">
                            <div class="message-bubble ai-bubble">
                                <i class="fas fa-robot"></i> ${data.answer}
                                <div class="mt-2">
                                    <small class="text-muted">
                                        信頼度: ${(data.confidence * 100).toFixed(1)}%
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    chatContainer.innerHTML += `
                        <div class="message ai-message">
                            <div class="message-bubble ai-bubble">
                                <i class="fas fa-exclamation-triangle text-danger"></i> 
                                エラー: ${data.error}
                            </div>
                        </div>
                    `;
                }
                chatContainer.scrollTop = chatContainer.scrollHeight;
            })
            .catch(error => {
                chatContainer.innerHTML += `
                    <div class="message ai-message">
                        <div class="message-bubble ai-bubble">
                            <i class="fas fa-exclamation-triangle text-danger"></i> 
                            エラー: ${error.message}
                        </div>
                    </div>
                `;
            });

            document.getElementById('question-input').value = '';
        }

        // クイックアクション
        function quickAction(action) {
            let question = '';
            let tag = action;

            switch(action) {
                case 'harvest':
                    question = '現在の豆苗の収穫タイミングを判断してください';
                    break;
                case 'disease':
                    question = '豆苗の病気を診断してください';
                    break;
                case 'cooking':
                    question = '収穫した豆苗の調理例を教えてください';
                    break;
            }

            document.getElementById('question-input').value = question;
            selectTag(tag);
            sendQuestion();
        }

        // 履歴読み込み
        function loadHistory() {
            fetch('/api/ai/history?limit=5')
                .then(response => response.json())
                .then(data => {
                    const historyContainer = document.getElementById('history-container');
                    if (data.history && data.history.length > 0) {
                        historyContainer.innerHTML = data.history.map(entry => `
                            <div class="small mb-2">
                                <strong>${entry.task_type}</strong><br>
                                <span class="text-muted">${entry.timestamp.split('T')[0]}</span>
                            </div>
                        `).join('');
                    } else {
                        historyContainer.innerHTML = '<p class="text-muted small">履歴がありません</p>';
                    }
                })
                .catch(error => {
                    console.error('履歴取得エラー:', error);
                });
        }

        // Enterキーで送信
        document.getElementById('question-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendQuestion();
            }
        });

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            // デフォルトタグを選択
            selectTag('general');
            loadHistory();
        });
    </script>
</body>
</html>
