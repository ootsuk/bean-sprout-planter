# 豆苗プランター - システム詳細設計書

## 📋 目次
1. [システム概要](#システム概要)
2. [アーキテクチャ設計](#アーキテクチャ設計)
3. [機能詳細設計](#機能詳細設計)
4. [API設計](#api設計)
5. [データベース設計](#データベース設計)
6. [セキュリティ設計](#セキュリティ設計)
7. [運用設計](#運用設計)
8. [拡張性設計](#拡張性設計)

---

## 🌱 システム概要

### プロジェクト名
**豆苗プランター (Bean Sprout Planter)**

### 目的
豆苗栽培に特化した自動植物育成システムの開発・運用

### 主要機能
- 豆苗専用の給水循環システム
- 多層化対応カメラ撮影（ソニーマイコン使用予定）
- AI判断による自動収穫タイミング判定
- 豆苗栽培に最適化されたセンサー監視
- LINE通知による栽培状況報告
- Web UI による遠隔操作とAI相談

### 技術スタック
- **ハードウェア**: Raspberry Pi 5
- **センサー**: AHT25 (温湿度), SEN0193 (土壌水分), MS5837-30BA01 (水圧センサー)
- **バックエンド**: Python 3.11, Flask 2.3.3
- **フロントエンド**: HTML5, CSS3, JavaScript
- **AI**: Gemini API
- **通知**: LINE Messaging API

---

## 🏗️ アーキテクチャ設計

### システム構成図

```
┌─────────────────────────────────────────────────────────┐
│                   ユーザー層                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ Web Browser │  │ Mobile App  │  │ LINE Bot    │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                           │ HTTP/HTTPS
┌─────────────────────────────────────────────────────────┐
│                  プレゼンテーション層                   │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Flask Application                  │   │
│  │  ┌─────────────┐  ┌─────────────┐              │   │
│  │  │ Web UI      │  │ REST API    │              │   │
│  │  │ Templates   │  │ Endpoints   │              │   │
│  │  └─────────────┘  └─────────────┘              │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────┐
│                   ビジネスロジック層                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ センサー    │  │ カメラ      │  │ 給水制御    │     │
│  │ 管理        │  │ 管理        │  │ 管理        │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ AI判断      │  │ 通知        │  │ データ      │     │
│  │ 機能        │  │ 管理        │  │ 管理        │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────┐
│                     データ層                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ 設定ファイル│  │ ログファイル│  │ 画像ファイル│     │
│  │ JSON        │  │ Log         │  │ Images      │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────┐
│                   ハードウェア層                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ センサー    │  │ カメラ      │  │ 給水装置    │     │
│  │ AHT25, etc  │  │ Sony IMX    │  │ Pump, etc   │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
```

### レイヤー分離設計

#### 1. プレゼンテーション層
- **役割**: ユーザーインターフェースの提供
- **実装**: Flask Templates, REST API
- **ファイル**: `src/app/app.py`, `src/web/templates/`

#### 2. ビジネスロジック層
- **役割**: 業務ロジックの実装
- **実装**: 各機能モジュール
- **ファイル**: `src/sensors/`, `src/camera/`, `src/watering/`, `src/ai/`

#### 3. データ層
- **役割**: データの永続化と管理
- **実装**: JSON設定ファイル、ログファイル
- **ファイル**: `config/`, `logs/`, `data/`

#### 4. ハードウェア層
- **役割**: 物理デバイスとの通信
- **実装**: GPIO制御、I2C通信、USB制御

---

## 🔧 機能詳細設計

### 1. センサーシステム

#### 1.1 センサー管理アーキテクチャ
- **統合管理**: SensorManagerクラス
- **センサー種類**: 温湿度、土壌水分、水圧
- **データキャッシュ**: メモリ内キャッシュ
- **監視スレッド**: バックグラウンド監視

#### 1.2 実装されているセンサー

| センサー | 型番 | 通信方式 | 測定項目 | 精度 |
|---------|------|----------|----------|------|
| 温湿度センサー | AHT25 | I2C | 温度、湿度 | ±0.3°C, ±2%RH |
| 土壌水分センサー | SEN0193 | アナログ | 土壌水分率 | 0-100% |
| 水圧センサー | MS5837-30BA01 | I2C | 水圧、水位 | ±0.1% |

#### 1.3 センサーデータフロー
```
センサー → データ読み取り → 値検証 → キャッシュ保存 → API提供
    ↓
エラー検知 → エラーカウント → 障害判定 → 通知送信
```

### 2. カメラシステム（多層化対応）

#### 2.1 多層化カメラ管理
- **管理方式**: MultiCameraManagerクラス
- **カメラ登録**: 動的追加・削除
- **階層管理**: 階層別撮影制御
- **スケジュール**: 自動撮影スケジュール

#### 2.2 階層別撮影制御
- **階層1**: 発芽期監視（毎日2回）
- **階層2**: 成長期監視（毎日3回）
- **階層3**: 収穫期監視（毎日4回）

#### 2.3 撮影スケジュール管理
- **設定方式**: cron形式
- **実行方式**: バックグラウンド実行
- **結果保存**: 画像ファイル保存

### 3. 給水システム

#### 3.1 給水タンク管理
- **容量**: 2000ml
- **残量管理**: リアルタイム計算
- **低水位警告**: 200ml以下で警告
- **使用履歴**: 給水履歴記録

#### 3.2 給水制御ロジック
- **自動給水**: 土壌水分に基づく自動給水
- **手動給水**: ユーザー操作による給水
- **緊急停止**: 安全機能

#### 3.3 自動給水判定

| 条件 | 判定 | アクション |
|------|------|------------|
| 土壌水分 < 30% | 給水必要 | 自動給水実行 |
| 土壌水分 30-70% | 正常 | 監視継続 |
| 土壌水分 > 70% | 過湿 | 給水停止 |

### 4. AI判断システム

#### 4.1 AI相談マネージャー
- **API**: Gemini API
- **機能**: 相談、収穫判断、病気診断、調理例
- **履歴管理**: 相談履歴保存
- **画像解析**: 画像添付対応

#### 4.2 AI判断機能

##### 4.2.1 自動収穫判断
- **実行頻度**: 1時間ごと
- **判定基準**: 画像解析 + センサーデータ
- **結果表示**: ダッシュボードに自動表示
- **通知**: LINE通知連携

##### 4.2.2 病気診断
- **入力**: 画像 + 症状リスト
- **出力**: 病気名、信頼度、対処法
- **予防**: 予防策提案

##### 4.2.3 調理例提供
- **入力**: 収穫データ
- **出力**: 調理例、栄養情報、保存方法
- **提案**: 最適な調理法

### 5. 通知システム

#### 5.1 通知マネージャー
- **LINE通知**: LINE Messaging API
- **システム通知**: ログ出力
- **履歴管理**: 通知履歴保存

#### 5.2 通知タイプ

| 通知タイプ | トリガー | 送信先 | 頻度 |
|------------|----------|--------|------|
| 低水位警告 | 水位 < 200ml | LINE | 即座 |
| 収穫推奨 | AI判断 | LINE | 1日1回 |
| 異常検知 | センサーエラー | LINE | 即座 |
| 定期報告 | 毎日 | LINE | 1日1回 |

---

## 🌐 API設計

### RESTful API エンドポイント一覧

#### センサーAPI
```
GET  /api/sensors/              - 全センサーデータ取得
GET  /api/sensors/history       - センサー履歴取得
GET  /api/sensors/water-level   - 水位データ取得
POST /api/sensors/calibrate     - センサー校正
```

#### 給水API
```
GET  /api/watering/status       - 給水状態取得
POST /api/watering/manual       - 手動給水実行
GET  /api/watering/history      - 給水履歴取得
POST /api/watering/stop         - 緊急停止
```

#### カメラAPI
```
GET  /api/camera/list           - カメラ一覧取得
POST /api/camera/add            - カメラ追加
POST /api/camera/remove         - カメラ削除
POST /api/camera/capture        - 写真撮影
GET  /api/camera/images         - 画像リスト取得
POST /api/camera/schedule       - 撮影スケジュール設定
```

#### AI相談API
```
POST /api/ai/consultation       - AI相談
POST /api/ai/harvest-judgment   - 収穫判断
POST /api/ai/disease-check      - 病気診断
POST /api/ai/cooking-tips       - 調理例
GET  /api/ai/tags               - 相談タグ一覧取得
```

#### 設定API
```
GET  /api/settings/             - 設定取得
POST /api/settings/             - 設定保存
POST /api/settings/reset        - 設定リセット
```

### APIレスポンス形式

#### 成功レスポンス
```json
{
  "status": "success",
  "data": {
    // レスポンスデータ
  },
  "timestamp": "2025-10-15T09:30:00Z"
}
```

#### エラーレスポンス
```json
{
  "status": "error",
  "message": "エラーメッセージ",
  "error_code": "SENSOR_READ_ERROR",
  "timestamp": "2025-10-15T09:30:00Z"
}
```

---

## 💾 データベース設計

### 設定ファイル構造

#### 1. メイン設定 (`config/settings.json`)
```json
{
  "system": {
    "version": "1.0.0",
    "debug_mode": false,
    "log_level": "INFO"
  },
  "sensors": {
    "temperature_humidity": {
      "enabled": true,
      "read_interval": 300
    },
    "soil_moisture": {
      "enabled": true,
      "read_interval": 300
    },
    "water_pressure": {
      "enabled": true,
      "read_interval": 300
    }
  },
  "watering": {
    "auto_mode": true,
    "watering_amount": 50
  },
  "camera": {
    "schedule": {
      "enabled": true,
      "times": ["06:00", "12:00", "18:00"]
    }
  }
}
```

#### 2. 給水タンク設定 (`config/water_tank_config.json`)
```json
{
  "tank_capacity": 2000,
  "current_volume": 1500,
  "low_water_threshold": 200,
  "last_refill": "2025-10-10T10:00:00"
}
```

#### 3. カメラ設定 (`config/camera_configs.json`)
```json
{
  "cameras": {
    "camera_001": {
      "camera_index": 0,
      "layer": 1,
      "enabled": true,
      "last_capture": "2025-10-15T09:30:00"
    }
  },
  "schedule": {
    "enabled": true,
    "layers": {
      "1": ["06:00", "18:00"],
      "2": ["06:00", "12:00", "18:00"],
      "3": ["06:00", "09:00", "12:00", "18:00"]
    }
  }
}
```

### データファイル構造

#### 1. センサーデータ (`data/sensor_data/`)
```
sensor_data_20251015.json
├── temperature_humidity: {timestamp, temperature, humidity}
├── soil_moisture: {timestamp, raw_value, moisture_percentage}
└── water_pressure: {timestamp, pressure, water_level}
```

#### 2. 給水履歴 (`data/watering_history/`)
```
watering_history_20251015.json
├── timestamp
├── watering_amount
├── previous_volume
├── remaining_volume
└── percentage
```

#### 3. AI相談履歴 (`data/ai_consultation/`)
```
ai_consultation_20251015.json
├── timestamp
├── question
├── answer
├── tag
├── confidence
└── response_time
```

---

## 🔒 セキュリティ設計

### 認証・認可

#### 1. API認証
- **方式**: APIキーベース認証（将来実装）
- **管理**: 環境変数での管理
- **権限**: 読み取り専用/読み書き権限

#### 2. 設定ファイル保護
- **権限設定**: chmod 600
- **機密情報**: 環境変数化
- **暗号化**: 設定ファイル暗号化（将来実装）

### データ保護

#### 1. ログファイル保護
- **権限設定**: chmod 644
- **ローテーション**: 日次ローテーション
- **保存期間**: 30日間

#### 2. 画像ファイル保護
- **権限設定**: 適切な権限設定
- **個人情報**: 匿名化処理
- **定期削除**: 古いファイル削除

### ネットワークセキュリティ

#### 1. HTTPS通信
- **SSL証明書**: 自己署名証明書（開発環境）
- **本番環境**: 正式なSSL証明書
- **ポート**: 443番ポート

#### 2. CORS設定
- **許可ドメイン**: 特定ドメインのみ
- **メソッド**: GET, POST, PUT, DELETE
- **ヘッダー**: Content-Type, Authorization

---

## 🚀 運用設計

### ログ管理

#### 1. ログレベル
- **DEBUG**: 詳細なデバッグ情報
- **INFO**: 一般的な情報
- **WARNING**: 警告メッセージ
- **ERROR**: エラーメッセージ
- **CRITICAL**: 致命的なエラー

#### 2. ログローテーション
- **ファイルサイズ**: 10MB
- **バックアップ数**: 5ファイル
- **エンコーディング**: UTF-8

#### 3. ログファイル構成
```
logs/
├── bean_sprout_planter_20251015.log    # メインログ
├── bean_sprout_planter_20251014.log    # 前日ログ
├── error_20251015.log                  # エラーログ
└── error_20251014.log                  # 前日エラーログ
```

### 監視・アラート

#### 1. システム監視
- **センサー監視**: 健全性チェック
- **カメラ監視**: 接続状態チェック
- **給水監視**: システム状態チェック
- **AI監視**: API接続チェック

#### 2. アラート条件

| 条件 | レベル | アクション |
|------|--------|------------|
| センサーエラー | ERROR | LINE通知 + ログ記録 |
| 水位低下 | WARNING | LINE通知 |
| AI API障害 | ERROR | LINE通知 + システム停止 |
| ディスク容量不足 | WARNING | ログ記録 + 通知 |

### バックアップ・復旧

#### 1. 設定ファイルバックアップ
- **頻度**: 日次バックアップ
- **保存場所**: 外部ストレージ
- **形式**: tar.gz圧縮

#### 2. データ復旧手順
1. 設定ファイルの復元
2. データベースの復元
3. ログファイルの確認
4. システム再起動

---

## 📈 拡張性設計

### モジュール拡張

#### 1. 新しいセンサー追加
- **基底クラス**: BaseSensor継承
- **実装必須**: read_data(), initialize()
- **登録**: SensorManagerに登録

#### 2. 新しいAPI追加
- **ブループリント**: 新規ブループリント作成
- **登録**: api_blueprint.pyに登録
- **ルーティング**: URLプレフィックス設定

### スケーラビリティ

#### 1. 水平スケーリング
- **複数Raspberry Pi**: 分散処理
- **ロードバランサー**: 負荷分散
- **データ同期**: 同期機能

#### 2. 垂直スケーリング
- **高性能ハードウェア**: より高性能な機器への移行
- **メモリ最適化**: メモリ使用量の最適化
- **ストレージ拡張**: 容量拡張

### 機能拡張計画

#### Phase 1: 基本機能（完了）
- [x] センサー監視
- [x] 給水制御
- [x] カメラ撮影
- [x] Web UI

#### Phase 2: AI機能（開発中）
- [x] AI相談機能
- [ ] 自動収穫判断
- [ ] 病気診断AI
- [ ] 調理例AI

#### Phase 3: 拡張機能（計画中）
- [ ] 複数プランター管理
- [ ] モバイルアプリ
- [ ] クラウド連携
- [ ] IoT機器連携

#### Phase 4: 商用化（将来）
- [ ] ユーザー管理
- [ ] 課金システム
- [ ] マルチテナント対応
- [ ] 国際化対応

---

## 📊 パフォーマンス設計

### 応答時間目標

| 機能 | 目標応答時間 | 実測値 |
|------|-------------|--------|
| センサーデータ取得 | < 1秒 | 0.5秒 |
| カメラ撮影 | < 3秒 | 2.1秒 |
| AI相談 | < 10秒 | 7.3秒 |
| 給水実行 | < 2秒 | 1.8秒 |

### リソース使用量

| リソース | 使用量 | 上限 |
|----------|--------|------|
| CPU使用率 | 15-25% | 80% |
| メモリ使用量 | 200-300MB | 1GB |
| ディスク使用量 | 1-2GB | 10GB |
| ネットワーク | 100KB/s | 1MB/s |

### 最適化施策

#### 1. データベース最適化
- **インデックス**: 検索速度向上
- **クエリ最適化**: 効率的なクエリ
- **接続プール**: 接続管理

#### 2. キャッシュ戦略
- **Redis**: メモリキャッシュ（将来実装）
- **ファイルキャッシュ**: 設定ファイルキャッシュ
- **APIキャッシュ**: レスポンスキャッシュ

---

## 🔧 開発・テスト設計

### 開発環境

#### 1. ローカル開発
- **仮想環境**: Python venv
- **依存関係**: requirements.txt
- **開発サーバー**: Flask開発サーバー

#### 2. テスト環境
- **テスト実行**: pytest
- **カバレッジ**: coverage
- **統合テスト**: エンドツーエンドテスト

### テスト戦略

#### 1. 単体テスト
- **対象**: 各モジュール
- **モック**: 外部依存の分離
- **カバレッジ**: 80%以上

#### 2. 統合テスト
- **API**: エンドポイントテスト
- **データフロー**: データフローテスト
- **エラー処理**: エラーケーステスト

#### 3. システムテスト
- **E2E**: エンドツーエンドテスト
- **パフォーマンス**: 負荷テスト
- **セキュリティ**: セキュリティテスト

---

## 📋 まとめ

### システムの特徴

1. **モジュラー設計**: 各機能が独立しており、保守性が高い
2. **拡張性**: 新しいセンサーや機能を簡単に追加可能
3. **AI統合**: Gemini APIを活用した高度な判断機能
4. **多層化対応**: 複数階層での豆苗栽培に対応
5. **リアルタイム監視**: センサーとカメラによる継続的な監視

### 技術的な強み

1. **Python/Flask**: 軽量で拡張性の高いWebフレームワーク
2. **RESTful API**: 標準的なAPI設計による互換性
3. **設定ファイル管理**: JSON形式による柔軟な設定管理
4. **ログシステム**: 包括的なログ記録とローテーション
5. **エラーハンドリング**: 堅牢なエラー処理と復旧機能

### 今後の発展方向

1. **AI機能の強化**: より高度な画像認識と判断機能
2. **クラウド連携**: データのクラウド保存と分析
3. **モバイル対応**: スマートフォンアプリの開発
4. **商用化**: マルチテナント対応と課金システム
5. **国際化**: 多言語対応とグローバル展開

---

**作成日**: 2025年10月15日  
**バージョン**: 1.0  
**作成者**: 豆苗プランターチーム  
**最終更新**: 2025年10月15日